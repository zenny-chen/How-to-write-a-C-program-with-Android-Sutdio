æœ€è¿‘ç¬”è€…ç”¨ä¸Šäº†Android Studio 3.2ï¼Œæ„Ÿè§‰è¿™ä¸ªç‰ˆæœ¬å¯¹Cè¯­è¨€çš„æ”¯æŒå˜å¾—æ›´å‹å¥½äº†ï¼Œåœ¨IDEå±‚é¢å¯¹Cè¯­è¨€é”™è¯¯çš„è§£æä¸Šä¹Ÿå®Œå…¨å…¼å®¹äº†GNU11æ ‡å‡†ï¼Œå¯è°“éå¸¸èˆ’æœã€‚æ‰€ä»¥ç¬”è€…ä¹Ÿå¼ºçƒˆæ¨èå„ä½ä½¿ç”¨Windowsç³»ç»Ÿçš„å°ä¼™ä¼´ä»¬å¯ä»¥è€ƒè™‘Android Studioè¿™æ¬¾å®Œå…¨å…è´¹çš„å·¥å…·æ¥å¼€å‘å­¦ä¹ Cè¯­è¨€ï¼

å¤§å®¶å¯ä»¥åœ¨æ­¤å¤„ä¸‹è½½å½“å‰æœ€æ–°ç‰ˆçš„Android Studioï¼š[https://developer.android.google.cn/studio/](https://developer.android.google.cn/studio/)ã€‚

å„ä½æ”¾å¿ƒï¼Œè¿™ä¸ªé“¾æ¥æ˜¯Googleä¸“é—¨é’ˆå¯¹ä¸­å›½å¼€å‘è€…æ‰€è®¾ç«‹çš„ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€å¼€å¯ä»»ä½•VPNæˆ–å…¶ä»–æœåŠ¡å™¨ä»£ç†å³å¯å¿«é€Ÿä¸‹è½½ï¼Œè€Œåç»­çš„æ’ä»¶ä¹Ÿæ˜¯èƒ½è¢«å¿«é€Ÿä¸‹è½½ï¼Œä¸éœ€è¦åšå…¶ä»–é¢å¤–ç½‘ç»œé…ç½®ä¸Šçš„å·¥ä½œã€‚

<br />

Android Studioé»˜è®¤é‡‡ç”¨çš„æ˜¯Javaç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦åšCè¯­è¨€å¼€å‘çš„è¯éœ€è¦é¢å¤–ä¸‹è½½ä¸€äº›æ’ä»¶ï¼Œå„ä½å¯ä»¥å…ˆæ‰“å¼€Android Sutdioï¼Œç„¶ååœ¨æ¬¢è¿ç•Œé¢å¤„ç‚¹å‡»â€œConfigureâ€ï¼Œå†é€‰æ‹©â€œSDK Managerâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![1.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/1.png)

å®Œæˆä¹‹åï¼ŒAndroid Studioå°†ä¼šå¼¹å‡ºåå¥½è®¾ç½®å¯¹è¯æ¡†ï¼Œå¹¶ä¸”åº”è¯¥é»˜è®¤å®šæ ¼åœ¨â€œAndroid SDKâ€è¿™ä¸ªé…ç½®é€‰é¡¹ä¸Šã€‚å„ä½ç‚¹å‡»â€œSDK Toolsâ€é€‰é¡¹å¡ï¼Œç„¶åè¿™é‡Œéœ€è¦å‹¾é€‰ä¸Šâ€œCMakeâ€ã€â€œLLDBâ€ä»¥åŠâ€œNDKâ€è¿™ä¸‰é¡¹ã€‚è€Œx86æ¨¡æ‹Ÿå™¨åŠ é€Ÿå™¨ä¹Ÿå»ºè®®é€‰ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![2.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/2.png)

ç‚¹å‡»OKä¹‹åï¼ŒAndroid Studioå°±å¼€å§‹å®‰è£…äº†ã€‚

<br />

å®‰è£…å®Œä¸Šè¿°æ’ä»¶ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹åˆ›å»ºä¸€ä¸ªCè¯­è¨€é¡¹ç›®å·¥ç¨‹äº†ã€‚ç”±äºä¸€ä¸ªAndroidé¡¹ç›®é»˜è®¤ä½¿ç”¨Javaï¼Œå¦‚æœè¦ç”¨Cè¯­è¨€çš„è¯éœ€è¦é€šè¿‡JNIè¿›è¡Œæ¡¥æ¥ã€‚å¦‚æœå„ä½æ„Ÿè§‰éº»çƒ¦çš„è¯ï¼Œç¬”è€…è¿™é‡Œæä¾›äº†ä¸€ç§å¯ä»¥å®Œå…¨ä½¿ç”¨çº¯Cè¯­è¨€çš„é¡¹ç›®é…ç½®æ–¹æ³•ã€‚
å„ä½å…ˆåœ¨æ¬¢è¿ç•Œé¢ä¸Šç‚¹å‡»â€œStart a new Android Studio projectâ€ã€‚ç„¶åè¿›å…¥é¡¹ç›®åé…ç½®ç•Œé¢ï¼Œç¬”è€…è¿™é‡Œå°±ä½¿ç”¨CTestã€‚å…¬å¸åéšä¾¿å¡«ï¼Œä½†ä¸€èˆ¬æ ¼å¼ä¸ºxxx.comï¼Œæˆ–è€…xxx.yyy.comã€‚å½“ç„¶ï¼Œè¿™é‡Œæœ€æœ€é‡è¦çš„æ˜¯**å¿…é¡»è¦å‹¾é€‰ä¸Š**â€œInclude C++ Supportâ€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![3.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/3.png)

éšåæˆ‘ä»¬ç‚¹å‡»â€œNextâ€æŒ‰é’®ï¼Œè¿›å…¥åˆ°SDKé…ç½®ç•Œé¢ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤é…ç½®å³å¯ã€‚å†ç‚¹å‡»â€œNextâ€ï¼Œè¿›å…¥Activityé…ç½®ç•Œé¢ï¼Œè¿™é‡ŒåŒæ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„â€œEmpty Activityâ€å³å¯ã€‚å†ç‚¹å‡»â€œNextâ€æŒ‰é’®ï¼Œè¿›å…¥åˆ°Activityçš„åˆ›å»ºç•Œé¢ã€‚ç”±äºæˆ‘ä»¬è¿™é‡Œä¸éœ€è¦Javaç«¯çš„ä»£ç ï¼Œä¹Ÿä¸éœ€è¦GUIç›¸å…³çš„å…ƒç´ ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å–æ¶ˆå‹¾é€‰â€œGenerate Layout Fileâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![4.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/4.png)

æœ€åå†æ¬¡ç‚¹å‡»â€œNextâ€æŒ‰é’®ï¼Œé…ç½®C++é€‰é¡¹ã€‚ç”±äºæˆ‘ä»¬åé¢è¦ä½¿ç”¨çš„æ˜¯Cï¼Œä¸æ˜¯C++ï¼Œå› æ­¤è¿™é‡Œä½¿ç”¨é»˜è®¤çš„å·¥å…·é“¾é…ç½®å³å¯ã€‚æ­¤å¤–ï¼Œä¸‹é¢çš„â€œException Supportâ€ä¸â€œRuntime Type Information Supportâ€éƒ½**ä¸è¦å‹¾é€‰**ä¸Šã€‚ç‚¹å‡»â€œFinishâ€æŒ‰é’®ä¹‹åå®Œæˆæ‰€æœ‰é…ç½®ã€‚æˆ‘ä»¬å°±è¿›å…¥äº†é¡¹ç›®å·¥ç¨‹ç•Œé¢ã€‚æ­¤æ—¶ï¼ŒAndroid Studioå°†ä¼šè‡ªåŠ¨ç¼–è¯‘æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼Œå®Œæˆä¹‹åå°±ä¼šè·³å…¥Activityçš„Javaä»£ç æºæ–‡ä»¶ç•Œé¢ã€‚

<br />

æˆ‘ä»¬ä¸‹é¢è¦åšçš„äº‹æƒ…æ˜¯åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶ã€‚æˆ‘ä»¬å…ˆæ‰“å¼€æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç®¡ç†å™¨ï¼Œè¿›å…¥CTesté¡¹ç›®ç›®å½•ä¸‹çš„`app/src/`ç›®å½•ä¸­ï¼ŒæŠŠæ•´ä¸ªâ€œtestâ€æ–‡ä»¶ä»¥åŠâ€œandroidTestâ€å¤¹å…¨éƒ½åˆ é™¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![5.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/5.png)

ç„¶åè¿›å…¥`app/src/main/`ç›®å½•ä¸‹ï¼ŒæŠŠæ•´ä¸ª`java`æ–‡ä»¶å¤¹å…¨éƒ½åˆ é™¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![6.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/6.png)

ç„¶åè¿›å…¥`app/src/main/cpp`ç›®å½•ï¼Œå°†â€œnative-lib.cppâ€æ”¹åä¸ºâ€œnative-lib.câ€ã€‚

<br />

å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å›åˆ°Android Studioï¼Œæ­¤æ—¶Android Studioä¼šè‡ªåŠ¨åˆ·æ–°åŒæ­¥ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°åŸæœ¬æ‰€åŒ…å«çš„â€œnative-lib.cppâ€æºæ–‡ä»¶ä¸è§äº†ï¼Œæˆ‘ä»¬ä¸ç”¨æ‰æ€¥ï¼Œå…ˆç‚¹å¼€â€œmanifestsâ€æ–‡ä»¶å¤¹ä¸­çš„â€œAndroidManifest.xmlâ€æ–‡ä»¶ï¼Œæˆ‘ä»¬è¦å¯¹å®ƒè¿›è¡Œç¼–è¾‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![7.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/7.png)

æˆ‘ä»¬éœ€è¦åœ¨`<application>`æ ‡ç­¾ä¸­æ·»åŠ `android:hasCode="false"`å±æ€§ï¼Œè¡¨ç¤ºæˆ‘ä»¬ä¸éœ€è¦Javaä»£ç ã€‚ç„¶åæ›¿æ¢æ‰æ•´ä¸ª`<activity>`æ ‡ç­¾å†…å®¹ã€‚ä¿®æ”¹å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![8.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/8.png)

ä¸‹é¢åˆ—å‡ºå®Œæ•´çš„â€œAndroidManifest.xmlâ€æ–‡ä»¶çš„ä»£ç ï¼š

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.zenny_chen.ctest">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme"
        android:hasCode="false">
        <!-- æˆ‘ä»¬ä¸éœ€è¦Javaä»£ç  -->

        <!-- Our activity is the built-in NativeActivity framework class.
             This will take care of integrating with our NDK code. -->
        <activity android:name="android.app.NativeActivity"
            android:label="@string/app_name"
            android:configChanges="orientation|keyboardHidden">
            <!-- Tell NativeActivity the name of our .so -->
            <meta-data android:name="android.app.lib_name"
                android:value="native-lib" />
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

    </application>

</manifest>
```

<br />

Manifestæ–‡ä»¶ç¼–è¾‘å®Œæˆåï¼Œæˆ‘ä»¬æ¥ç€å°±è¦å¼€å§‹ç¼–è¾‘gradleæ–‡ä»¶äº†ã€‚æˆ‘ä»¬æ‰¾åˆ°â€œbuild.gradle (Module:app)â€è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åç‚¹å¼€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![9.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/9.png)

å„ä½æ³¨æ„ï¼Œé¡¹ç›®å·¥ç¨‹ä¸­æœ‰ä¸¤ä¸ªgradleæ–‡ä»¶ï¼Œåˆ«ç‚¹é”™äº†ã€‚åœ¨æ­¤gradleæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åªç¼–è¾‘`android`å—ä¸­çš„å†…å®¹ã€‚æ”¹åŠ¨çš„åœ°æ–¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![10.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/10.png)

åœ¨ä¸Šå›¾ä¸­ï¼Œndkå—ä¸­çš„abiFilterså‚æ•°æŒ‡å®šäº†æˆ‘ä»¬å½“å‰NDK Cè¯­è¨€é¡¹ç›®å°†é’ˆå¯¹å“ªäº›å¤„ç†å™¨æ¶æ„ç”Ÿæˆç›®æ ‡ä»£ç ã€‚è¿™é‡ŒæŒ‡å®šäº†ä¸‰ä¸ªï¼š'x86_64'è¡¨ç¤ºé’ˆå¯¹64ä½x86å¤„ç†å™¨ï¼Œ'armeabi-v7a'è¡¨ç¤ºé’ˆå¯¹ARMv7-Aæ¶æ„å¤„ç†å™¨ï¼Œ'arm64-v8a'è¡¨ç¤ºé’ˆå¯¹ARMv8-Aæ¶æ„å¤„ç†å™¨ã€‚æ‰€ä»¥å¯¹äºæœ¬demoé¡¹ç›®è€Œè¨€ï¼Œæœ€ç»ˆç”Ÿæˆçš„ç›®æ ‡ä»£ç ä¸­ä¸åŒ…å«32ä½çš„x86æ¶æ„ï¼Œå› æ­¤æˆ‘ä»¬åé¢åœ¨è®¾ç½®æ¨¡æ‹Ÿå™¨çš„æ—¶å€™éœ€è¦å…ˆä¸‹è½½64ä½çš„x86æ¨¡æ‹Ÿå™¨ï¼Œåé¢ä¼šè¯¦ç»†æè¿°ã€‚

ä¸‹é¢ç»™å‡ºå®Œæ•´çš„gradleæ–‡ä»¶å†…å®¹ï¼š

```gradle
apply plugin: 'com.android.application'

android {
    compileSdkVersion 28
    defaultConfig {
        applicationId "com.zenny_chen.ctest"
        minSdkVersion 17
        targetSdkVersion 28
        versionCode 1
        versionName "1.0"
        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
        externalNativeBuild {
            cmake {
                // å¯¹äºARMv7-Aæ¶æ„å¤„ç†å™¨çš„å¹³å°ï¼Œä½¿ç”¨NEONæŠ€æœ¯ï¼›å¯¹äºæ‰€æœ‰ARMæ¶æ„å¤„ç†å™¨çš„å¹³å°ï¼Œä½¿ç”¨ARMæ¨¡å¼æŒ‡ä»¤
                arguments "-DANDROID_ARM_NEON=TRUE", "-DANDROID_ARM_MODE=arm"

                // Cè¯­è¨€ä½¿ç”¨GNU11æ ‡å‡†ï¼Œå¹¶ä»¥ä»£ç æœ€å°å°ºå¯¸æœ€å¿«é€Ÿåº¦è¿›è¡Œä¼˜åŒ–
                cFlags "-std=gnu11", "-Os"
            }
        }
        ndk {
            // Specifies the ABI configurations of your native
            // libraries Gradle should build and package with your APK.
            abiFilters 'x86_64', 'armeabi-v7a', 'arm64-v8a'
        }
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
    externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation 'com.android.support:appcompat-v7:28.0.0'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.2'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'
}
```

<br />

è¿™ä¸ªå®Œæˆä¹‹åï¼Œæˆ‘ä»¬æœ€åå†è¦ç¼–è¾‘ä¸€ä¸‹CMakeLists.txtæ–‡ä»¶ã€‚å®ƒåœ¨ä¸‹å›¾æ‰€ç¤ºçš„ä½ç½®ï¼š

![11.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/11.png)

ç”±äºAndroid Studioä½¿ç”¨çš„æ˜¯CMakeå·¥å…·ï¼Œå› æ­¤å¯¹æºæ–‡ä»¶çš„ç¼–è¯‘é…ç½®ä»¥åŠåŠ¨æ€åº“çš„ç”Ÿæˆéƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æŒ‡å®šã€‚è¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```cmake
# For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html

# Sets the minimum version of CMake required to build the native library.

cmake_minimum_required(VERSION 3.4.1)

include(AndroidNdkModules)
android_ndk_import_module_cpufeatures()
android_ndk_import_module_native_app_glue()

# Export ANativeActivity_onCreate(),
# Refer to: https://github.com/android-ndk/ndk/issues/381.
set(CMAKE_SHARED_LINKER_FLAGS
        "${CMAKE_SHARED_LINKER_FLAGS} -u ANativeActivity_onCreate")

# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.

add_library( # Sets the name of the library.
        native-lib

        # Sets the library as a shared library.
        SHARED

        # Provides a relative path to your source file(s).
        src/main/cpp/native-lib.c)

# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.

find_library( # Sets the name of the path variable.
        log-lib

        # Specifies the name of the NDK library that
        # you want CMake to locate.
        log)

# Specifies libraries CMake should link to your target library. You
# can link multiple libraries, such as libraries you define in this
# build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # Specifies the target library.
        native-lib
        cpufeatures
        android
        native_app_glue

        # Links the target library to the log library
        # included in the NDK.
        ${log-lib})
```

å¯¹äºä¸Šè¿°é…ç½®ä»£ç ï¼Œå¯¹äºåˆå­¦è€…è€Œè¨€åªéœ€çŸ¥é“ä»¥ä¸‹å‡ ç‚¹ï¼š
1. `add_library`ä¸‹é¢çš„ç¬¬ä¸€è¡Œç”¨äºæŒ‡å®šå½“å‰ç¼–è¯‘æ„å»ºé¡¹ç›®æœ€ç»ˆæ‰€ç”Ÿæˆçš„åº“çš„åç§°ã€‚
1. `add_library`ä¸‹é¢çš„ç¬¬äºŒè¡Œç”¨äºæŒ‡å®šå½“å‰é¡¹ç›®ä½¿ç”¨çš„æ˜¯é™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“ã€‚ç”±äºæˆ‘ä»¬æ•´ä¸ªé¡¹ç›®æœ€ç»ˆè¦è¢«Androidç³»ç»Ÿçš„Javaè™šæ‹Ÿæœºè°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”ŸæˆåŠ¨æ€åº“ï¼Œç”¨`SHARED`æŒ‡å®šã€‚
1. `add_library`ä¸‹é¢çš„ç¬¬ä¸‰è¡Œèµ·å°±ç”¨äºæŒ‡å®šæˆ‘ä»¬æ•´ä¸ªé¡¹ç›®æ‰€è¦ç¼–è¯‘æ„å»ºçš„æºæ–‡ä»¶ã€‚è¿™é‡Œå¯ä»¥å¡«å†™.cæºæ–‡ä»¶ã€.cppæºæ–‡ä»¶æˆ–.asmæ±‡ç¼–æºæ–‡ä»¶ã€‚å¤šä¸ªæºæ–‡ä»¶ä¹‹é—´ç”¨**ç©ºæ ¼ç¬¦**æˆ–**æ¢è¡Œç¬¦**è¿›è¡Œåˆ†éš”ã€‚è¿™é‡Œè¿˜éœ€æ³¨æ„çš„æ˜¯ï¼Œæºæ–‡ä»¶çš„æ ¹ç›®å½•ä¸º`src/main/cpp/`ï¼Œè¿™ä¸ªéœ€è¦åŠ ä¸Šï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬åœ¨æ­¤æ ¹ç›®å½•ä¸‹è¿˜å¯ä»¥å†æ·»åŠ è‡ªå·±çš„æ–‡ä»¶å¤¹ã€‚
1. åœ¨`target_link_libraries`ä¸­éœ€è¦æŠŠæˆ‘ä»¬å½“å‰ç”Ÿæˆçš„åº“æœ¬èº«åŠ è¿›å»ï¼Œä¸€èˆ¬å°±æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½®ã€‚

<br />

è¿™äº›é…ç½®å·¥ä½œå°±å…¨éƒ½å®Œæˆä¹‹åï¼ŒAndroid Studioä¼šåœ¨å³ä¸Šè§’å¼¹å‡ºâ€œSyncâ€è¶…é“¾æ¥æ ·å¼çš„æŒ‰é’®ï¼Œæˆ‘ä»¬ç‚¹å‡»å®ƒï¼Œå¯¹æ•´ä¸ªé¡¹ç›®é‡æ–°æ„å»ºã€‚ç„¶åæˆ‘ä»¬å°±èƒ½çœ‹åˆ°â€œnative-lib.câ€è¿™ä¸ªæºæ–‡ä»¶äº†ã€‚å®ƒåœ¨ä¸‹å›¾æ‰€ç¤ºçš„ä½ç½®ï¼š

![12.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/12.png)

<br />

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒAndroid Studioé»˜è®¤ä½¿ç”¨çš„æ–‡ä»¶ç¼–ç æ ¼å¼ä¸ºUTF-8ï¼Œä½†åœ¨Windowsç³»ç»Ÿä¸Šå¯èƒ½é»˜è®¤è®¾ç½®ä¸ºGBKï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦ç”¨è·¨å¹³å°é€šç”¨çš„UTF-8æ–‡ä»¶ç¼–ç æ ¼å¼çš„è¯å¯ä»¥åœ¨Android Studioçš„åå¥½è®¾ç½®ä¸­æŸ¥çœ‹å½“å‰è®¾ç½®çš„æ–‡ä»¶ç¼–ç æ ¼å¼æ˜¯å¦ä¸ºUTF-8ã€‚æˆ‘ä»¬å…ˆæ‰¾åˆ°è®¾ç½®æ–‡ä»¶ç¼–ç æ ¼å¼çš„åœ°æ–¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![13.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/13.png)

éšåï¼Œæˆ‘ä»¬åœ¨å³ä¾§å¯ä»¥çœ‹åˆ°å½“å‰é…ç½®çš„å…¨å±€ç¼–ç æ ¼å¼ä¸é¡¹ç›®ç¼–ç æ ¼å¼ï¼Œæˆ‘ä»¬éƒ½å°†å®ƒä»¬é…ç½®ä¸ºUTF-8ç¼–ç æ ¼å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![14.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/14.png)

æ­¤å¤–ï¼Œåœ¨ä¸‹æ–¹æˆ‘ä»¬å†æ£€æŸ¥ä¸€ä¸‹â€œCreate UTF-8 Filesâ€æ˜¯å¦ä¸ºâ€œwith NO BOMâ€ï¼Œæˆ‘ä»¬æ‰€åˆ›å»ºçš„UTF-8æ–‡ä»¶åº”è¯¥ä¸å¸¦æœ‰BOMã€‚

![15.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/15.png)

éƒ½è®¾ç½®å®Œæˆåç‚¹å‡»å³ä¸‹æ–¹çš„â€œOKâ€æŒ‰é’®å³å¯ã€‚

<br />

ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç¼–è¾‘native-lib.cæºæ–‡ä»¶äº†ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªAndroidåº”ç”¨ï¼Œå› æ­¤å®ƒæ˜¯æ²¡æœ‰ä¼ ç»Ÿä¸Šçš„`main`å‡½æ•°çš„ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä»¥`android_main`ä½œä¸ºå‡½æ•°å…¥å£ã€‚æ­¤å¤–ï¼ŒAndroid NDKä¸­ä¹Ÿå»é™¤äº†Cè¯­è¨€çš„æ ‡å‡†è¾“å…¥è¾“å‡ºæµï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªæ§åˆ¶å°åº”ç”¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬éœ€è¦åŠ¨æ€è¾“å…¥æ•°æ®çš„è¯åªèƒ½é€šè¿‡è¯»å†™æ–‡ä»¶è¿›è¡Œã€‚
è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹Androidçš„æ–‡ä»¶ç³»ç»Ÿèµ„æºç®¡ç†ä½“ç³»ã€‚å¦‚æœæˆ‘ä»¬è¦åœ¨å½“å‰Appä¸­å»è¯»æŸä¸ª**åªè¯»**çš„èµ„æºæ–‡ä»¶çš„è¯ï¼Œå¯ä»¥å°†è¯¥æ–‡ä»¶æ”¾åœ¨***assets***ç›®å½•å†…ï¼Œassetsç›®å½•ä¼šè¢«æ‹·è´åˆ°å½“å‰Appç›¸å…³çš„ç›®å½•ä¸­ã€‚ç”±äºAndroid Studioæ‰€ç”Ÿæˆçš„é¡¹ç›®ä¸­æ²¡æœ‰é»˜è®¤ç”Ÿæˆassetsæ–‡ä»¶å¤¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹å·¥åœ¨å½“å‰é¡¹ç›®å·¥ç¨‹çš„`app/src/main/`ç›®å½•ä¸‹åˆ›å»ºassetsç›®å½•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![16.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/16.png)

éšåï¼Œæˆ‘ä»¬å°†éœ€è¦è¢«Appæ‰€è¯»çš„æ–‡ä»¶æ”¾å…¥è¯¥assetsæ–‡ä»¶å¤¹é‡Œå³å¯ã€‚Android NDKæä¾›äº†ä¸€å¥—æ¥å£ç”¨äºè®¿é—®assetsä¸­çš„æ–‡ä»¶èµ„æºï¼š

```c 
AAsset *AAssetManager_open(AAssetManager *mgr, const char *filename, int mode)
```
è¿™ä¸ªå‡½æ•°ç”¨äºæ‰“å¼€æŒ‡å®šæ–‡ä»¶åçš„èµ„æºæ–‡ä»¶ã€‚å…¶ä¸­ï¼Œå‚æ•°mgråœ¨`struct android_app`å¯¹è±¡ä¸­å³å¯è·å¾—ã€‚`mode`å‚æ•°è¡¨ç¤ºèµ„æºæ–‡ä»¶è¯»å–çš„æ¨¡å¼ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸€æ¬¡è¯»å®Œå½“å‰æ–‡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆä½¿ç”¨`AASSET_MODE_BUFFER`å³å¯ã€‚è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªAAssetå¯¹è±¡å¼•ç”¨ï¼Œå®ƒç›¸å½“äºä¸€ä¸ªFILEå¥æŸ„ã€‚

```c
off_t AAsset_getLength(AAsset *asset)
```
ç”¨äºè·å–å½“å‰èµ„æºæ–‡ä»¶çš„é•¿åº¦ã€‚

```c
int AAsset_read(AAsset *asset, void *buf, size_t count)
```
è¯¥å‡½æ•°å°±ç”¨äºè¯»å–èµ„æºæ–‡ä»¶ã€‚

```c
void AAsset_close(AAsset *asset)
```
åœ¨è¯»å®Œèµ„æºæ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªå‡½æ•°å°†å®ƒå…³é—­ã€‚

å¦‚æœæˆ‘ä»¬è¦å†™æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`app->activity->internalDataPath`æ‰€æŒ‡å®šçš„è·¯å¾„ã€‚åœ¨è¯¥è·¯å¾„ä¸‹çš„æ–‡ä»¶å¯ä»¥è¢«ç”¨æˆ·åˆ›å»ºã€ä¿®æ”¹ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨æ ‡å‡†Cçš„æ–‡ä»¶è¯»å†™æ–¹å¼å³å¯å¯¹å®ƒè¿›è¡Œè®¿é—®ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬ç»™å‡ºæœ¬demoçš„æ‰€æœ‰native-lib.cæºæ–‡ä»¶çš„å†…å®¹ï¼š

```c
#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <stdatomic.h>

#include <cpu-features.h>
#include <syslog.h>

#include <android/hardware_buffer.h>
#include <android/native_activity.h>
#include <android/native_window.h>
#include <android/rect.h>
#include <android/window.h>
#include <android_native_app_glue.h>

#ifndef var
#define var     __auto_type
#endif


/*
 * å¯¹å†…è”æ±‡ç¼–ä»£ç è¿›è¡Œæµ‹è¯•çš„å‡½æ•°ã€‚å¯¹äºx86-64æ¶æ„è®¡ç®—é™¤æ³•è¿ç®—ï¼›å¯¹äºå…¶ä»–æ¶æ„è®¡ç®—å¹³æ–¹å·®ã€‚
 * @param a å¯¹äºx86-64æ¶æ„ä½œä¸ºè¢«é™¤æ•°ï¼›å¯¹äºå…¶ä»–æ¶æ„ä½œä¸ºè¢«å‡æ•°
 * @param b å¯¹äºx86-64æ¶æ„ä½œä¸ºé™¤æ•°ï¼›å¯¹äºå…¶ä»–æ¶æ„ä½œä¸ºå‡æ•°
 * @return è¿ç®—ç»“æœ
 */
static int __attribute__((naked, pure)) InlineASMTest(int a, int b)
{
#ifdef __x86_64__
    // ä»¥ä¸‹ä»£ç é’ˆå¯¹x86-64æ¶æ„ï¼Œè®¡ç®— a / b
    asm("pmuldq     %xmm1, %xmm0");
    asm("vpmuldq    %ymm1, %ymm0, %ymm0");
    asm("mov    %edi, %eax");
    asm("xor    %edx, %edx");
    asm("idiv   %esi");
    asm("ret");

#elif defined(__arm__)
    // ä»¥ä¸‹ä»£ç é’ˆå¯¹ARMv7ä»¥åŠæ›´ä½ç‰ˆæœ¬çš„ARMæ¶æ„
    asm("mul    r0, r0, r0");
    asm("mls    r0, r1, r1, r0");
    asm("bx     lr");

#elif defined(__aarch64__)
    // ä»¥ä¸‹ä»£ç é’ˆå¯¹ARM64å¤„ç†å™¨ï¼ˆæ¯”å¦‚ARMv8-Aï¼‰ï¼Œè®¡ç®—a * a - b * b
    asm("mul    w0, w0, w0");
    asm("msub   w0, w1, w1, w0");
    asm("ret");

#endif
}


/*
 * ç”¨äºAndroidåº”ç”¨çš„æ¶ˆæ¯å“åº”å¤„ç†çš„å›è°ƒå‡½æ•°
 * @param app è¡¨ç¤ºå½“å‰åº”ç”¨çš„å¯¹è±¡
 * @param cmd è¡¨ç¤ºå½“å‰æ¥æ”¶åˆ°çš„å‘½ä»¤
 */
static void Android_handle_cmd(struct android_app *app, int32_t cmd)
{
    switch (cmd)
    {
        case APP_CMD_INIT_WINDOW:
        {
            // The window is being shown, get it ready.
            syslog(LOG_INFO, "Activity awoken!!");

            break;
        }

        case APP_CMD_TERM_WINDOW:
            // The window is being hidden or closed, clean it up.
            break;

        case APP_CMD_STOP:
            // Command from main thread: the app's activity has been stopped.
            syslog(LOG_INFO, "Activity stopped!!");

            break;

        case APP_CMD_DESTROY:

            syslog(LOG_INFO, "The app is destroyed!!");
            break;

        default:
            syslog(LOG_INFO, "event not handled: %d", cmd);
            break;
    }
}

/*
 * This is the main entry point of a native application that is using
 * android_native_app_glue.  It runs in its own thread, with its own
 * event loop for receiving input events and doing other things.
 */
void android_main(struct android_app* app)
{
    // TODO: æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå†™æµ‹è¯•ç¨‹åº
    syslog(LOG_INFO, "Entering android main function!");

    // æ ¹æ®æ–‡ä»¶åæ‰“å¼€èµ„æºæ–‡ä»¶
    AAsset* asset = AAssetManager_open(app->activity->assetManager, "test.info", AASSET_MODE_BUFFER);
    if(asset == NULL)
    {
        syslog(LOG_EMERG, "test.info not found!");
        return;
    }
    // è·å–æ–‡ä»¶é•¿åº¦
    const size_t length = (size_t)AAsset_getLength(asset);

    // åˆ†é…å­˜æ”¾æ–‡ä»¶å†…å®¹çš„ç¼“å­˜
    char *buffer = malloc(length);

    // è¯»å–æ–‡ä»¶å†…å®¹
    AAsset_read(asset, buffer, length);

    // å…³é—­æ–‡ä»¶å¥æŸ„
    AAsset_close(asset);

    syslog(LOG_INFO, "The file content is: %s", buffer);

    char filePath[256];
    strcpy(filePath, app->activity->internalDataPath);
    syslog(LOG_INFO, "File path: %s", filePath);
    strcat(filePath, "/output.txt");

    // å‡†å¤‡å°†ç¼“å­˜å†…å®¹å†™å…¥è®¾å¤‡çš„SDå¡å†…
    FILE *fp = fopen(filePath, "w");
    if(fp != NULL)
    {
        fwrite(buffer, 1, length, fp);
        fclose(fp);
    }
    else
        syslog(LOG_EMERG, "file cannot be opened!");

    free(buffer);

    // æ±‡ç¼–å‡½æ•°æµ‹è¯•
#ifdef __x86_64__
    int remainder;
    const int quotient = InlineASMTest(10, 7);
    asm("mov    %%edx, %0" :"=r"(remainder));
    syslog(LOG_INFO, u8"é™¤æ³•ç»“æœå•†ä¸ºï¼š%dï¼Œä½™æ•°ä¸ºï¼š%d", quotient, remainder);
#else
    const int result = InlineASMTest(5, 4);
    syslog(LOG_INFO, u8"å¹³æ–¹å·®çš„ç»“æœä¸ºï¼š%d", result);
#endif

    // å¯¹åŸå­æ“ä½œè¿›è¡Œæµ‹è¯•
    atomic_flag flag = ATOMIC_FLAG_INIT;
    if(!atomic_flag_test_and_set(&flag))
        syslog(LOG_INFO, "flag is set!");
    else
        syslog(LOG_INFO, "flag is locked!");

    if(!atomic_flag_test_and_set(&flag))
        syslog(LOG_INFO, "flag is set!");
    else
        syslog(LOG_INFO, "flag is locked!");

    atomic_flag_clear(&flag);

    if(!atomic_flag_test_and_set(&flag))
        syslog(LOG_INFO, "flag is set!");
    else
        syslog(LOG_INFO, "flag is locked!");

    atomic_int atomInt;
    atomic_init(&atomInt, 10);
    var value = atomic_fetch_add(&atomInt, 5);
    const var desired = atomic_load(&atomInt);
    syslog(LOG_INFO, "original value = %d, added value = %d", value, desired);

    if(!atomic_compare_exchange_strong(&atomInt, &value, desired))
        syslog(LOG_INFO, "CAS failed!");
    else
        syslog(LOG_INFO, "CAS succeeded!");

    if(!atomic_compare_exchange_strong(&atomInt, &value, desired))
        syslog(LOG_INFO, "CAS failed!");
    else
        syslog(LOG_INFO, "CAS succeeded!");

    // å¯¹C11çš„æ³›å‹è¿›è¡Œæµ‹è¯•
    var type = _Generic("abc", const char*:1, char*:2, const char[4]:3, char[4]:4, default:0);
    syslog(LOG_INFO, "type = %d", type);

    // ç³»ç»Ÿæ¶ˆæ¯å¾ªç¯å¤„ç†
    app->onAppCmd = Android_handle_cmd;

    // Main loop
    do {
        int events;
        struct android_poll_source *source;

        // Poll all pending events.
        if(ALooper_pollAll(0, NULL, &events, (void**)&source) >= 0)
        {
            // Process each polled events
            if(source != NULL)
                source->process(app, source);
        }
    }
    // Check if system requested to quit the application
    while(app->destroyRequested == 0);
}
```

å¯¹äºåœ¨Android Studioä¸­å†™æ±‡ç¼–ï¼Œç¬”è€…å»ºè®®ä½¿ç”¨Cè¯­è¨€çš„å†…è”æ±‡ç¼–å½¢å¼æ¯”è¾ƒé è°±ã€‚å› ä¸ºå•ç‹¬çš„æ±‡ç¼–æºæ–‡ä»¶æ— æ³•è®¾ç½®æ–­ç‚¹ï¼Œå› æ­¤ä¸æ˜“äºè°ƒè¯•ã€‚

<br />

ç¼–è¾‘å®Œä¹‹åï¼Œæˆ‘ä»¬ç‚¹å‡»å·¥å…·æ çš„ç»¿è‰²ç®­å¤´å³å¯è¿è¡Œæ­¤ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![17.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/17.png)

æˆ–è€…ä½¿ç”¨åº•éƒ¨**Run**æ ‡ç­¾é‡Œçš„ç»¿è‰²ç®­å¤´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![18.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/18.png)

<br />

åœ¨ç‚¹å‡»è¿è¡ŒæŒ‰é’®ä¹‹åä¼šå¼¹å‡ºå¯¹è¯æ¡†ï¼Œè¦æ±‚é€‰æ‹©ç”¨å“ªç§è®¾å¤‡è¿è¡Œå½“å‰Appã€‚å¦‚æœæˆ‘ä»¬è¦ç”¨æ¨¡æ‹Ÿå™¨è¿è¡Œçš„è¯å¯ä»¥åˆ›å»ºä¸€å°è™šæ‹Ÿè®¾å¤‡ã€‚ç‚¹å‡»â€œCreate New Virtual Deviceâ€æŒ‰é’®ï¼Œè¿›å…¥åˆ°ä¸‹é¢çš„å¯¹è¯æ¡†ã€‚

![19.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/19.png)

è¿™é‡Œè¦æ±‚æˆ‘ä»¬é€‰æ‹©ä¸€å°è®¾å¤‡çš„å‹å·å±å¹•å°ºå¯¸ã€‚ç¬”è€…å»ºè®®ï¼Œå¦‚æœå„ä½å½“å‰å±å¹•åˆ†è¾¨ç‡ä¸å¤ªé«˜çš„è¯é€‰æ‹©åˆ†è¾¨ç‡ä½ä¸€ç‚¹çš„è™šæ‹Ÿè®¾å¤‡ï¼Œå¦‚æœé«˜çš„è¯å¯ä»¥è€ƒè™‘åˆ†è¾¨ç‡é«˜çš„è®¾å¤‡ã€‚æˆ‘ä»¬é€‰å®Œä¹‹åç‚¹å‡»â€œNextâ€æŒ‰é’®ã€‚

![20.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/20.png)

è¿™é‡Œå±•ç°çš„æ˜¯é€‰æ‹©è®¾å¤‡é•œåƒã€‚ç”±äºæœ¬demoä½¿ç”¨çš„æ˜¯x86-64æ¶æ„ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»é€‰æ‹©x86_64çš„é•œåƒæ–‡ä»¶ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬æœ€å¥½å†è¦é€‰æ‹©å½“å‰Android Studioæ‰€æ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬çš„Androidç³»ç»Ÿã€‚å¦‚æœå½“å‰é•œåƒéœ€è¦ä¸‹è½½ï¼Œæˆ‘ä»¬ç‚¹å‡»â€œDownloadâ€ä¸‹è½½å³å¯ã€‚

<br />

å†ç‚¹å‡»â€œNextâ€æŒ‰é’®ä¹‹åå°±æ˜¯å¯¹å½“å‰è™šæ‹Ÿè®¾å¤‡çš„å‘½åé…ç½®ï¼Œæˆ‘ä»¬èµ·å¥½ä¸€ä¸ªåä¹‹åç‚¹å‡»â€œFinishâ€æŒ‰é’®å³å¯å®Œæˆã€‚å›åˆ°ä¹‹å‰çš„å¯¹è¯æ¡†ï¼Œé€‰æ‹©æˆ‘ä»¬åˆšå»ºç«‹å¥½çš„è™šæ‹Ÿè®¾å¤‡å³å¯å¼€å§‹è¿è¡Œç¨‹åºäº†ã€‚æˆ‘ä»¬åœ¨IDEåº•éƒ¨çš„Runæ ‡ç­¾æ ä¸­å¯ä»¥çœ‹åˆ°è¾“å‡ºlogä¿¡æ¯ã€‚

![21.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/21.png)

å¦‚æœæˆ‘ä»¬ç”¨Androidè®¾å¤‡è¿›è¡ŒçœŸæœºè°ƒè¯•ï¼ŒRunæ ‡ç­¾æ ä¸­å¯èƒ½æ— æ³•æ‰“å°å‡ºç›¸å…³ä¿¡æ¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è§‚å¯ŸLogcatä¸­çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![22.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/22.png)

<br />

ç”±äºLogcatè®¾è®¡å¾—æ¯”è¾ƒâ€œçµæ´»â€ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹å®ƒé’ˆå¯¹çš„æ˜¯ä¹‹å‰æ‰€é€‰æ‹©çš„è®¾å¤‡åšlogæ•è·ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿æ¥å¥½æ–°çš„è®¾å¤‡ä¹‹åï¼Œéœ€è¦é€‰æ‹©å·¦ä¸Šè§’çº¢æ¡†æ¡†å‡ºæ¥çš„é€‰æ‹©æ¡†ï¼Œç„¶åé€‰æ‹©å½“å‰è°ƒè¯•çš„è®¾å¤‡ã€‚ç„¶åï¼Œåœ¨æˆ‘ä»¬ç‚¹å‡»è¿è¡ŒæŒ‰é’®ä¹‹åï¼ˆæ³¨æ„ï¼Œå¿…é¡»è®©è®¾å¤‡å¼€å§‹è¿è¡Œå½“å‰Appï¼‰ï¼Œåœ¨è¿‡æ»¤å™¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©â€œShow only selected applicationâ€ï¼Œè¿™æ ·èƒ½è®©å½“å‰è®¾å¤‡è¾“å‡ºæ‰“å°çš„ä¸éœ€è¦çš„å†…å®¹å¤§å¹…å‡å°‘ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![23.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/23.png)

<br />

æˆ‘ä»¬åœ¨æœ¬demoä¸­æœ‰å†™æ–‡ä»¶åŠŸèƒ½ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æŸ¥çœ‹æ‰€å†™æ–‡ä»¶çš„ç»“æœå‘¢ï¼Ÿ
æ— è®ºæ˜¯åœ¨Androidæ¨¡æ‹Ÿå™¨ä¸­è¿˜æ˜¯å¯¹äºçœŸæœºè®¾å¤‡ï¼Œå¦‚æœæˆ‘ä»¬è¦æŸ¥çœ‹æ¨¡æ‹Ÿå™¨è®¾å¤‡é‡Œæ‰€å†™å…¥çš„æ–‡ä»¶å†…å®¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Android Studioè‡ªå¸¦çš„Device File Explorerå·¥å…·ã€‚åœ¨ç‰ˆæœ¬è¾ƒè€çš„Android Studioä¸­ï¼ŒDevice File Exploreråœ¨å·¥å…·æ ä¸Šï¼Œå¯è§è¿™ç¯‡åšæ–‡ï¼šhttps://blog.csdn.net/zhaoyanjun6/article/details/72284543

è€Œåœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­å®ƒè—åœ¨æ•´ä¸ªIDEå·¥å…·çš„å³ä¸‹è§’ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![24.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/24.png)

è¿™ç•Œé¢è®¾è®¡å¾—éå¸¸è¯¡å¼‚â€¦â€¦ç„¶åæˆ‘ä»¬é€‰æ‹©éœ€è¦æŸ¥çœ‹çš„è®¾å¤‡ï¼Œå†æ ¹æ®æ‰“å°è¾“å‡ºçš„è·¯å¾„æ‰¾åˆ°æˆ‘ä»¬æ‰€å†™çš„æ–‡ä»¶ã€‚ç„¶åé¼ æ ‡å³é”®ç‚¹å‡»å®ƒï¼Œå†é€‰æ‹©â€œSave Asâ€å¦å­˜ä¸ºåˆ°æˆ‘ä»¬è‡ªå·±æ¡Œé¢ç³»ç»Ÿä¸Šçš„æŸä¸ªè·¯å¾„ä¸‹å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![25.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/25.png)

<br />

ä¸‹é¢æˆ‘ä»¬å°†è°ˆè°ˆAndroid Studioå¯¹ç¨‹åºçš„è°ƒè¯•ã€‚è·Ÿå…¶ä»–ä¸»æµIDEä¸€æ ·ï¼ŒAndroid Studioä¹Ÿå…è®¸æˆ‘ä»¬ä½¿ç”¨æ–­ç‚¹è°ƒè¯•ã€‚ä¸è¿‡ç›®å‰èƒ½æ”¯æŒæ–­ç‚¹çš„åªæœ‰Javaï¼ˆåŒ…æ‹¬Kotlinï¼‰ã€Cå’ŒC++æºæ–‡ä»¶ï¼Œæ±‡ç¼–æºæ–‡ä»¶ä¸æ”¯æŒæ–­ç‚¹è°ƒè¯•ã€‚è®¾ç½®æ–­ç‚¹çš„æ–¹æ³•ä¹Ÿè·Ÿå…¶ä»–ä¸»æµIDEä¸€æ ·ï¼Œåœ¨ä»£ç ç¼–è¾‘æ¡†å·¦ä¾§æ˜¾ç¤ºè¡Œå·çš„ç°è‰²åŒºåŸŸé¼ æ ‡å·¦é”®ç‚¹å‡»ä¸€ä¸‹å³å¯ã€‚å½“ç¨‹åºæ‰§è¡Œåˆ°æ–­ç‚¹è¿™ä¸€è¡Œåå°†ä¼šæš‚åœï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿå„ä¸ªå±€éƒ¨å˜é‡ä»¥åŠå…¨å±€å˜é‡çš„å€¼ã€‚ä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨Android Studioè°ƒè¯•ç¨‹åºæ—¶ä¸èƒ½ç‚¹å‡»è¿è¡ŒæŒ‰é’®ï¼Œè€Œæ˜¯å¿…é¡»ç‚¹å‡»**è°ƒè¯•æŒ‰é’®**ï¼Œå®ƒä½äºä¸‹å›¾æ‰€ç¤ºçš„å·¥å…·æ ï¼š

![26.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/26.png)

<br />

å½“æˆ‘ä»¬ç‚¹å‡»è°ƒè¯•æŒ‰é’®ä¹‹åï¼Œç¨‹åºå°†ä¼šä»¥è°ƒè¯•æ¨¡å¼å¼€å§‹è¿è¡Œã€‚å½“ç¨‹åºè¿è¡Œåˆ°æˆ‘ä»¬è®¾ç½®æ–­ç‚¹çš„é‚£è¡Œä»£ç ä¹‹åä¼šå‡ºç°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æƒ…å†µï¼š

![27.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/27.png)

è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°æ–­ç‚¹å¤„é‚£è¡Œä¹‹åï¼Œè¯¥è¡Œä»£ç ä¼šä»¥è“è‰²æ¡é«˜äº®æ˜¾ç¤ºï¼ŒåŒæ—¶æ–­ç‚¹é‡Œé¢ä¹Ÿä¼šæœ‰ä¸€ä¸ªæµ…è“è‰²çš„æ‰“å‹¾æ ‡è®°ã€‚è€Œåœ¨ä¸‹é¢å·¦ä¾§æœ‰ä¸€æ’æŒ‰é’®ã€‚åœ¨Debugé€‰é¡¹æ ä¸­çš„ç»¿è‰²æŒ‰é’®è¡¨ç¤ºResumeï¼Œå³è®©å½“å‰ç¨‹åºç»§ç»­æ‰§è¡Œã€‚çº¢è‰²æ–¹å—åˆ™è¡¨ç¤ºåœæ­¢å½“å‰ç¨‹åºçš„è¿è¡Œã€‚åœ¨å³ä¾§ä¹Ÿæœ‰ä¸¤ä¸ªé€‰é¡¹å¡ï¼Œé»˜è®¤å®šæ ¼åœ¨Varaiblesï¼Œè¿™ä¸ªç”¨äºè§‚å¯Ÿå½“å‰å‡½æ•°é‡Œçš„å±€éƒ¨å˜é‡ã€‚è§‚å¯Ÿå…¨å±€å˜é‡æœ‰ä¸¤ç§å½¢å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥åœ¨æºæ–‡ä»¶ä¸­æ‰¾åˆ°æ‰€è¦è§‚å¯Ÿçš„é‚£ä¸ªå…¨å±€å˜é‡ï¼Œç„¶åé¼ æ ‡å…‰æ ‡æŒ‡å‘è¯¥å˜é‡åï¼Œç„¶åAndroid Studioç¨åå°±ä¼šæ˜¾ç¤ºå‡ºè¯¥å…¨å±€å˜é‡çš„å€¼ã€‚è¿˜æœ‰ä¸€ç§æ˜¯ä½¿ç”¨è°ƒè¯•å™¨æœ¬èº«å¯¹è¡¨è¾¾å¼çš„è®¡ç®—èƒ½åŠ›ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è®²è¿™ä¸ªä¸œè¥¿ã€‚æˆ‘ä»¬ç›´æ¥ç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºçš„çº¢è‰²æ¡†æ¡†å‡ºæ¥çš„æŒ‰é’®ï¼Œå°±èƒ½å¼¹å‡ºè®¡ç®—è¡¨è¾¾å¼çš„æ¡†æ¡†ã€‚

![28.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/28.png)

ç„¶åæˆ‘ä»¬åœ¨å¼¹å‡ºçš„æ¡†æ¡†ä¸­è¾“å…¥å½“å‰è°ƒè¯•å™¨çš„ä¸Šä¸‹æ–‡å·²ç»å¯è§çš„å˜é‡ï¼Œå³å¯è¿›è¡Œéšæ„è®¡ç®—ï¼Œç”šè‡³å¯ä»¥ç«‹å³ä¿®æ”¹æŸä¸ªå˜é‡çš„å€¼ï¼Œå¦‚æœå®ƒä¸æ˜¯å¸¸é‡çš„è¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![29.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/29.png)

é™¤äº†ç‚¹å‡»â€œè®¡ç®—è¡¨è¾¾å¼â€çš„æŒ‰é’®ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨LLDBåŠŸèƒ½æ¥åšæ›´å¤šæ›´å¤æ‚çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![30.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/30.png)

æ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿ï¼Œè€Œåˆçµæ´»å¼ºå¤§å‘¢ï¼ŸğŸ˜

<br />

æœ‰ç»éªŒçš„ç¨‹åºå‘˜éƒ½çŸ¥é“ï¼Œæ— è®ºæ˜¯Cè¯­è¨€é¡¹ç›®è¿˜æ˜¯Javaé¡¹ç›®ï¼Œå®ƒä»¬éƒ½æœ‰ä¸¤ç§ç¼–è¯‘æ„å»ºæ¨¡å¼ï¼Œä¸€ç§æ˜¯Debugæ¨¡å¼ï¼Œå¦ä¸€ç§æ˜¯Releaseæ¨¡å¼ã€‚Debugæ¨¡å¼ä¸‹ä»£ç ç”Ÿæˆéå¸¸è§„æ•´ï¼Œä¸”ä¾¿äºè°ƒè¯•ã€‚è€Œåœ¨Releaseæ¨¡å¼ä¸‹ï¼Œç¼–è¯‘å™¨å°†ä¼šæ ¹æ®æˆ‘ä»¬æ‰€æŒ‡å®šçš„ä¼˜åŒ–é€‰é¡¹å¯¹ä»£ç åšå¤§å¹…ä¼˜åŒ–ï¼Œæ­¤æ—¶ä»£ç è¿è¡Œé€Ÿåº¦ä¼šå˜å¿«ï¼Œä½†ä¸æ˜“äºè°ƒè¯•ã€‚å› æ­¤å½“æˆ‘ä»¬åœ¨è°ƒè¯•ç¨‹åºæ—¶å¾€å¾€éœ€è¦ä½¿ç”¨è°ƒè¯•æ¨¡å¼ï¼Œè€Œè¿™ä¹Ÿæ˜¯å„å¤§IDEçš„é»˜è®¤é€‰é¡¹ã€‚å¦‚æœæˆ‘ä»¬è¦å‘å¸ƒç¨‹åºäº†ï¼Œé‚£ä¹ˆå¯ä»¥åˆ‡æ¢åˆ°Releaseæ¨¡å¼ï¼Œä½¿å¾—ç¨‹åºçš„è¿è¡Œæ—¶æ€§èƒ½æ›´å¥½ã€‚åœ¨Android Studioä¸­ä¹Ÿæœ‰è®¾ç½®æ„å»ºæ¨¡å¼çš„æ–¹æ³•ã€‚å®ƒä½äºæ•´ä¸ªIDEçš„å·¦ä¸‹è§’ï¼Œåä¸ºâ€œBuild Variantsâ€ã€‚æˆ‘ä»¬ç‚¹å‡»å®ƒå°†ä¼šå¼¹å‡ºåŠæµ®æ¡†ï¼Œéšåæˆ‘ä»¬å°±å¯ä»¥è®¾ç½®è‡ªå·±æ‰€éœ€çš„æ„å»ºäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![31.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/31.png)

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒAndroid Studioä½¿ç”¨çš„æ˜¯Debugæ¨¡å¼ï¼Œæˆ‘ä»¬ç‚¹å‡»â€œDebugâ€å°†ä¼šå‡ºç°ä¸‹æ‹‰æ¡†ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©â€œReleaseâ€æ¥æ”¹é€‰ä¸ºReleaseæ¨¡å¼ã€‚

<br />

ä¸ºäº†èƒ½è®©å„ä½åœ¨Android Studioä¸­æ›´ä½“é¢åœ°ä½¿ç”¨æ‰“å°è¯­å¥ï¼ˆæ¯”å¦‚`printf`å’Œ`puts`ï¼‰ï¼Œç¬”è€…è¿™é‡Œç»™å„ä½æä¾›ä¸€ä¸ªç°æˆçš„å…¬å…±å¤´æ–‡ä»¶ï¼š

```c
// zenny_common.h

#pragma once

#ifdef __ANDROID__

#include <syslog.h>

#define printf(...)     syslog(LOG_INFO, __VA_ARGS__)

#define puts(cstr)      printf("%s\n", cstr)

#endif

#ifndef     let
#define     let     __auto_type
#endif

```

å‡å®šè¯¥å†…å®¹è¢«ä¿å­˜ä¸ºâ€œzenny_common.hâ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨Cæºæ–‡ä»¶ä¸­ä½¿ç”¨çš„æ—¶å€™å¯ä»¥å°†å®ƒ**åŒ…å«åœ¨æœ€åä¸€ä¸ªincludeçš„ä½ç½®å¤„**ã€‚ä¹‹æ‰€ä»¥è¿™é‡Œè¦ç‰¹åˆ«æåˆ°æ”¾åˆ°æœ€åä¸€ä¸ªincludeä½ç½®ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªå®ä¼šå°†<stdio.h>ä¸­æ‰€å®šä¹‰çš„ç¬¦å·ç»™æ›¿æ¢æ‰ï¼Œå› æ­¤å®ƒè‡³å°‘å¿…é¡»å£°æ˜åœ¨`#include <stdio.h>`çš„ä¸‹é¢ã€‚ç„¶åæˆ‘ä»¬åœ¨Cå‡½æ•°ä¸­å°±å¯ä»¥è¿™ä¹ˆå†™äº†ï¼š

```c
#include <stdio.h>
#include <stdbool.h>
#include <cpu-features.h>

#include "zenny_common.h"


static void Test(void)
{
    puts("Hello, world!");

    let a = 10, b = 20;

    printf("The sum is: %d\n", a + b);
}
```

å¦‚æœå„ä½è¿è¡Œç¨‹åºçš„è¯ï¼Œå°†ä¼šåœ¨Logcaté‡Œçœ‹åˆ°ä»¥ä¸‹æ‰“å°è¾“å‡ºï¼š

![32.png](https://github.com/zenny-chen/How-to-write-a-C-program-with-Android-Sutdio/blob/master/32.png)

<br />

å¦‚æœå„ä½æƒ³é€šè¿‡Android Studioè®©Javaä¸Cæ··ç”¨çš„ï¼Œå¯ä»¥å‚è€ƒæ­¤åšæ–‡ï¼š[åœ¨Android Studio 3.0ä¸­ä½¿ç”¨Cè¯­è¨€ä»¥åŠæ±‡ç¼–è¯­è¨€](https://www.jianshu.com/p/d2968991710b)

è€Œå…³äºJNIçš„è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒæ­¤åšæ–‡ï¼š[Java JNIæ¥å£çš„è¯¦ç»†æè¿°](https://www.jianshu.com/p/5c75f9ed5d94)

æœ€åé™„èµ å„ä¸ªå¤„ç†å™¨æ¶æ„åœ¨å„å¤§ç¼–è¯‘å™¨ä¸Šçš„é¢„å®šä¹‰çš„å®ï¼š[https://sourceforge.net/p/predef/wiki/Architectures/](https://sourceforge.net/p/predef/wiki/Architectures/)
